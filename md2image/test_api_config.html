<!DOCTYPE html>
<html>
<head>
    <title>API配置测试</title>
</head>
<body>
    <h1>API配置测试</h1>
    <div>
        <label>API Key:</label>
        <input type="text" id="apiKey" placeholder="输入你的OpenAI API Key" style="width: 400px;">
    </div>
    <br>
    <div>
        <label>Base URL:</label>
        <input type="text" id="baseUrl" value="https://api.openai.com/v1" style="width: 400px;">
    </div>
    <br>
    <div>
        <label>Model:</label>
        <input type="text" id="model" value="gpt-3.5-turbo" style="width: 400px;">
    </div>
    <br>
    <button onclick="testAPI()">测试API配置</button>
    <div id="result" style="margin-top: 20px; padding: 10px; border: 1px solid #ccc;"></div>

    <script>
        async function testAPI() {
            const apiKey = document.getElementById('apiKey').value;
            const baseUrl = document.getElementById('baseUrl').value;
            const model = document.getElementById('model').value;
            const resultDiv = document.getElementById('result');
            
            if (!apiKey.trim()) {
                resultDiv.innerHTML = '<span style="color: red;">请输入API Key</span>';
                return;
            }
            
            const request = {
                content: "测试内容：这是一个简单的测试文本。",
                task_type: "segment_text",
                aiConfig: {
                    baseUrl: baseUrl,
                    apiKey: apiKey,
                    modelName: model,
                    temperature: 0.7,
                    maxTokens: 2000
                }
            };
            
            resultDiv.innerHTML = '<span style="color: blue;">正在测试...</span>';
            
            try {
                const response = await fetch('http://localhost:8000/api/v1/enhance', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(request)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // 测试成功后保存配置到localStorage
                    const settings = {
                        aiConfig: {
                            baseUrl: baseUrl,
                            apiKey: apiKey,
                            modelName: model,
                            customModelName: '',
                            temperature: 0.7,
                            maxTokens: 2000
                        },
                        imageConfig: {
                            backgroundColor: '#ffffff',
                            backgroundImageType: 'none',
                            backgroundImage: '',
                            backgroundOpacity: 0.8,
                            backgroundSize: 'cover'
                        },
                        cssConfig: {
                            customCSS: '',
                            fontFamily: 'Inter, system-ui, sans-serif',
                            fontSize: 16,
                            lineHeight: 1.6,
                            textColor: '#1f2937'
                        }
                    };
                    
                    localStorage.setItem('md2image-settings', JSON.stringify(settings));
                    resultDiv.innerHTML = '<span style="color: green;">✅ AI连接测试成功! 配置已保存到主应用</span>';
                } else {
                    resultDiv.innerHTML = `<span style="color: red;">❌ 测试失败: ${data.error}</span>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<span style="color: red;">❌ 连接失败: ${error.message}</span>`;
            }
        }
    </script>
</body>
</html>